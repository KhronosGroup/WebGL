<!--

/*
** Copyright (c) 2016 The Khronos Group Inc.
**
** Permission is hereby granted, free of charge, to any person obtaining a
** copy of this software and/or associated documentation files (the
** "Materials"), to deal in the Materials without restriction, including
** without limitation the rights to use, copy, modify, merge, publish,
** distribute, sublicense, and/or sell copies of the Materials, and to
** permit persons to whom the Materials are furnished to do so, subject to
** the following conditions:
**
** The above copyright notice and this permission notice shall be included
** in all copies or substantial portions of the Materials.
**
** THE MATERIALS ARE PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
** EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
** MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
** IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
** CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
** TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
** MATERIALS OR THE USE OR OTHER DEALINGS IN THE MATERIALS.
*/

-->

<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>WebGL TexSubImage3D Tests</title>
<link rel="stylesheet" href="../../../resources/js-test-style.css"/>
<script src="../../../js/js-test-pre.js"></script>
<script src="../../../js/webgl-test-utils.js"></script>
</head>
<body>
<canvas id="example" width="8" height="8"></canvas>
<div id="description"></div>
<div id="console"></div>
<script>
"use strict";

var wtu = WebGLTestUtils;
description("This test verifies the functionality of TexSubImage3D.");

var gl = wtu.create3DContext("example", undefined, 2);

function multiple_write_to_subregion(target) {
    debug("");
    debug("TexSubImage3D should not modify the data outside of the subregion in 3D/2D_ARRAY texture");
    var texture = gl.createTexture();
    gl.bindTexture(target, texture);
    var width = 8;
    var height = 8;
    var depth = 8;
    gl.texImage3D(target, 0, gl.RGBA, width, height, depth, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);

    var offset = 0;
    var range = 2;
    var sub_3d = new Uint8Array(range * range * range * 4);
    for (var i = 0; i < range * range * range * 4; ++i) {
        sub_3d[i] = i;
    }

    // write the first subregion at [0, 0, 0]
    gl.texSubImage3D(target, 0, offset, offset, offset, range, range, range, gl.RGBA, gl.UNSIGNED_BYTE, sub_3d);

    // write the second subregion at [3, 3, 3]
    offset += 3;
    gl.texSubImage3D(target, 0, offset, offset, offset, range, range, range, gl.RGBA, gl.UNSIGNED_BYTE, sub_3d);

    // write the third subregion at [6, 6, 6]
    offset += 3;
    gl.texSubImage3D(target, 0, offset, offset, offset, range, range, range, gl.RGBA, gl.UNSIGNED_BYTE, sub_3d);

    var fbo = gl.createFramebuffer();
    gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);

    // read the first layer of the first subregion at [0, 0, 0]
    var readoffset = 0;
    var layer = 0;
    gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture, 0, layer);
    var pixels = new Uint8Array(range * range * 4);
    gl.readPixels(readoffset, readoffset, range, range, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
    for (var i = 0; i < range * range; ++i) {
        if (pixels[i] != sub_3d[i]) {
            testFailed("pixel comparison failure, pixel at (" + i / (range * 4) + ", " + i % (range * 4) + ") was " + pixels[i]);
            break;
        }
    }
    if (i == range * range) {
        testPassed("pixel comparison succeed");
    }

    // read the first layer of the second subregion at [3, 3, 3]
    layer += 3;
    readoffset += 3;
    gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture, 0, layer);
    gl.readPixels(readoffset, readoffset, range, range, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
    for (var i = 0; i < range * range; ++i) {
        if (pixels[i] != sub_3d[i]) {
            testFailed("pixel comparison failure, pixel at (" + (i / (range * 4) + readoffset) + ", " + (i % (range * 4) + readoffset) + ") was " + pixels[i]);
            break;
        }
    }
    if (i == range * range) {
        testPassed("pixel comparison succeed");
    }

    gl.bindTexture(gl.TEXTURE_3D, null);
    gl.bindFramebuffer(gl.FRAMEBUFFER, null);
    gl.deleteFramebuffer(fbo);
    gl.deleteTexture(texture);
};

if (!gl) {
    testFailed("WebGL context does not exist");
} else {
    testPassed("WebGL context exists");
    multiple_write_to_subregion(gl.TEXTURE_3D);
    multiple_write_to_subregion(gl.TEXTURE_2D_ARRAY);
}

var successfullyParsed = true;
</script>
<script src="../../../js/js-test-post.js"></script>

</body>
</html>
